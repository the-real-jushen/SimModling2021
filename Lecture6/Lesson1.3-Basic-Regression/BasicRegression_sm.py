# %% [markdown]
'''
## æ•°æ®ç§‘å­¦å…¥é—¨1.3ï¼šç®€å•çº¿æ€§å›å½’

## Introduction to Data Science Part1.3: Basic Regression 

## Pythonä¸­çš„ç®€å•çº¿æ€§å›å½’

### åŸºæœ¬çš„æ‹Ÿåˆ

>Exp 1ï¼šé¦–å…ˆæˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªæ•°æ®ï¼š

|    Weekly $ Ad Expense (x)    |    Weekly $ Sales (y)    |
|-------------------------------|--------------------------|
|    63,566                     |    651,334               |
|    50,762                     |    527,670               |
|    50,941                     |    523,751               |
|    17,597                     |    175,467               |
|    33,029                     |    377,978               |
|    58,543                     |    520,100               |
|    60,492                     |    620,856               |
|    59,686                     |    593,739               |
|    16,432                     |    181,949               |
|    17,262                     |    184,644               |
|    39,118                     |    379,374               |
|    36,078                     |    238,688               |
|    42,113                     |    410,066               |
|    50,562                     |    413,541               |
|    38,240                     |    340,242               |
|    59,870                     |    582,843               |

è¿™æ˜¯ä¸€ä¸ªå…¬å¸æ¯å‘¨çš„å¹¿å‘Šè´¹æ”¯å‡ºå’Œæ¯å‘¨é”€é‡çš„æ•°æ®å’Œæ¯å‘¨é”€å”®é¢çš„æ•°æ®ï¼Œæˆ‘ä»¬æƒ³é€šè¿‡å¹¿å‘Šè´¹æ”¯å‡ºæ¥é¢„æµ‹é”€å”®é¢ï¼Œé‚£ä»€ä¹ˆæ˜¯dependent variableä»€ä¹ˆæ˜¯independent variableéƒ½çŸ¥é“äº†å§ã€‚æˆ‘ä»¬é¦–å…ˆåœ¨pythonä¸ŠæŠŠè¿™ä¸ªæ•°æ®å¯¼å…¥ï¼Œç„¶åç”»ä¸ªå›¾ã€‚
'''
# %%
# å¯¼å…¥æ•°æ®
import pandas as pd
from matplotlib import pyplot as plt

df = pd.read_excel('exp_1.xlsx')
plt.scatter(df.iloc[:, 0], df.iloc[:, 1])
##plt.show()
# %% [markdown]
'''
ç„¶åæˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¿™äº›ç‚¹çš„åˆ†å¸ƒæ»¡è¶³å¹¿å‘ŠæŠ•å…¥è¶Šå¤§ï¼Œ
é”€å”®é¢ä¹Ÿè¶Šå¤šï¼ˆè¿™ä¸ªæœ‰ç‚¹å‡å“ˆï¼Œå¹¿å‘Šä¸å¾—è¦å‡ å¤©æ‰æœ‰æ•ˆå—ğŸ˜‚ï¼‰
'''

# %%
# å»ºç«‹æ¨¡å‹
import statsmodels.api as sm
X = df.iloc[:, 0]
y = df.iloc[:, 1]
X_int = sm.add_constant(X)  # statsmodelséœ€è¦æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªæˆªè·
model = sm.OLS(y, X_int)  # è¿™é‡Œå¥½åäººç±»ï¼Œä¼ é€’å‚æ•°é»˜è®¤æ˜¯å…ˆyåXï¼Œå½“ç„¶ä½ å¯ä»¥ä¼ æ˜¾å¼çš„(exog=X, endog=y)
res = model.fit()  # å»ºå¥½æ¨¡å‹fitä¸€ä¸‹
print(res.summary())  # è¿™é‡Œæœ‰ä¸ªsummary()æ–¹æ³•ï¼Œèƒ½æ‰“å°å‡ºæ¨¡å‹çš„æ‰€æœ‰ä¿¡æ¯

# %% [markdown]

'''
ä¸Šé¢è¿™ä¸ªä»£ç å…¶å®å¾ˆå®¹æ˜“ç†è§£å§ã€‚é¦–å…ˆæˆ‘ä»¬è°ƒç”¨ `sm.OLS()` 
æ–¹æ³•å¾—åˆ°ä¸€ä¸ªæ¨¡å‹ï¼Œé€è¿›å»çš„å‚æ•°åˆ†åˆ«æ˜¯yå’ŒX, æ³¨æ„è¿™é‡ŒXå¯ä»¥æ˜¯ä¸€ä¸ªçŸ©é˜µï¼Œå°±æ˜¯è¯´ä½ å¯èƒ½æœ‰å¤šå˜é‡çš„çº¿æ€§æ‹Ÿåˆã€‚
è¿™é‡Œçš„OLSæŒ‡çš„å°±æ˜¯Ordinary Least Square,æ™®é€šæœ€å°äºŒä¹˜
è¿™é‡Œå¦‚æœè¦æ‹Ÿåˆæˆªè·çš„è¯éœ€è¦æ‰‹åŠ¨å¢åŠ ä¸€ä¸ªXã€‚
è¿™é‡Œæˆ‘ä»¬ç”¨ä¸€ä¸ªindependent variableçš„ä¸€é˜¶çš„å¤šé¡¹å¼è¿›è¡Œæ‹Ÿåˆï¼Œå¾—åˆ°æ¨¡å‹ä¹‹åfitä¸€ä¸‹ï¼Œå°±æ˜¯ä¸€æ¡ç›´çº¿äº†ã€‚
è¿™é‡Œæˆ‘ä»¬ç›´æ¥å¯¹æ¨¡å‹summaryä¸€ä¸‹ï¼Œå°±å¯ä»¥çœ‹åˆ°æ¨¡å‹çš„å„ç§æ€§èƒ½äº†ã€‚

æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹æ¨¡å‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ¨¡å‹å’Œä¹‹å‰æ•°æ®çš„æ•£ç‚¹ç”»åœ¨ä¸€èµ·:
'''

# %% 
# æ‹Ÿåˆå›¾
plt.scatter(X, y, label='data')
import numpy as np
# è¦ç”»æ‹Ÿåˆå‡½æ•°çš„å›¾å°±ä¸ç”¨åŸå§‹æ•°æ®äº†ï¼Œæˆ‘ä»¬é‡æ–°ç”Ÿæˆä¸€ç»„Xï¼Œç­‰é—´è·ä¸”æ’åºå¥½çš„
plot_X = np.linspace(X.min(), X.max(), 20).reshape(-1, 1)
# è®¡ç®—æ‹Ÿåˆçš„å€¼
# output = res.params[0] + res.params[1] * plot_X  # ä¸å«Œéº»çƒ¦çš„è¯å¯ä»¥è¿™ä¹ˆå†™ï¼ˆåˆ’æ‰ï¼‰
output = res.predict(sm.add_constant(plot_X)) # ç›´æ¥predictå°±å¥½ï¼Œè®°å¾—åŠ æˆªè·ï¼Œå¦åˆ™ä¼šæŠ¥é”™
plt.plot(plot_X, output, color='red', label='fitted curve')
plt.legend()  # æ˜¾ç¤ºlabel

"""
è¿™é‡Œå¦‚æœæŠ¥äº†ä¸€ä¸ªè«åå…¶å¦™çš„`LinAlgError: SVD did not coverage`,
å°±é‡æ–°è¿è¡Œä¸€ä¸‹è¿™ä¸ªcellï¼Œåé¢å‡ºç°ç±»ä¼¼çš„ç›¸åŒã€‚
è¿™é‡Œæ˜¯WindowsæŸä¸ªç‰ˆæœ¬æ›´æ–°åçš„ä¸€ä¸ªbugï¼Œå¯ä»¥å‚è€ƒ
https://github.com/numpy/numpy/issues/16744ã€‚
è¿™æ¬¡è¯¾å…ˆè¿è¡Œä¸¤æ¬¡cellå§ï¼Œæœ‰éœ€æ±‚çš„å¯ä»¥æ‰¾æˆ‘è¦è¡¥ä¸ã€‚
"""
# %% [markdown]
'''
å¯ä»¥çœ‹åˆ°æ•ˆæœè¿˜æ˜¯å¾ˆå¥½çš„ã€‚ **é‚£è¿™ä¸ªæ¨¡å‹æ€ä¹ˆç”¨å‘¢ï¼Ÿ** 
æˆ‘ä»¬å…ˆæŠŠmodelæ‰“å°å‡ºæ¥ï¼š
'''
# %%
res.params
# %% [markdown]

'''
è§£é‡Šä¸€ä¸‹,
constå°±æ˜¯ä½ æ¨¡å‹çš„æˆªè·,Weekly...æ˜¯ä½ æ¨¡å‹çš„Xçš„ç³»æ•°ï¼Œä»–ä»¬çš„å€¼åˆ†åˆ«æ˜¯ `const = 36857.035880, (x) = 8.241549` ã€‚
è¦å®Œæˆä¸€æ¬¡é¢„æµ‹åªè¦æŠŠxå¸¦è¿›å»å°±è¡Œï¼Œæ‰§è¡Œ `y_hat=res.predict(X)` å°±è¡Œã€‚

æ³¨æ„è¿™ä¸ªåœ°æ–¹è¿˜æ˜¯è¦è®°å¾—æŠŠXåŠ ä¸ªæˆªè·é¡¹è¿›å»ï¼Œå¦åˆ™shapeä¸åŒä¼šæŠ¥é”™ã€‚

**æˆ‘ä»¬å†çœ‹çœ‹å¦‚ä½•è¯„ä¼°è¿™ä¸ªæ¨¡å‹**  
'''
# %%
res.summary()
# %% [markdown]

'''
è¿™é‡Œå¯ä»¥çœ‹åˆ°rsquareï¼Œå’Œadj_rsquareï¼Œè¿™ä¸ªä»£è¡¨äº†ä½ æ¨¡å‹è§£é‡Šè§‚æµ‹æ•°æ®çš„èƒ½åŠ›ï¼Œä¸¤ä¸ªæ•°å­—å·®ä¸å¤šï¼Œ
å¦‚æœä½ åªæœ‰ä¸€ä¸ªindependent variable,ä¸¤ä¸ªæ˜¯ä¸€å›äº‹ï¼Œ
å¦‚æœä½ æœ‰å¤šä¸ªå˜é‡ä½ å…³æ³¨çš„åº”è¯¥æ˜¯adj_rsquareï¼ˆadjusted r squareï¼‰ï¼Œ
å› ä¸ºå½“å˜é‡å¢å¤šçš„æ—¶å€™rsquareä¸€å®šä¼šå‡å°‘ï¼Œadjrsquareæ˜¯åªè€ƒè™‘significantçš„å˜é‡ï¼Œ
è¿™ä¸ªæˆ‘ä»¬å°±åœ¨è¿™é‡Œä¸å¤šè¯´äº†ã€‚ **è¿™ä¸ªadjrsquareæ˜¯è¶Šæ¥è¿‘1è¶Šå¥½ã€‚** 
æˆ‘ä»¬åœ¨ä¸‹é¢çš„å…¬å¼å’Œå›¾é‡Œé¢å¯ä»¥çœ‹åˆ°è¿™ä¸ªrsquareæ˜¯æ€ä¹ˆç®—çš„:

![](2020-02-12-09-56-19.png)  

$$
R^2=\frac{SST-SSR}{SSR}
\\
SST=\sum(y_i-\bar{y}^2)
\\
SSR=\sum(y_i-\hat{y}^2)
$$

å¯ä»¥çœ‹å‡ºæ¥SSTæ˜¯è¿™ä¸ªæ¨¡å‹ä¸å­˜åœ¨æ—¶ï¼Œæ‰€æœ‰çš„ç‚¹çš„å¹³æ–¹å’Œï¼Œ
$\bar{y}$ æ˜¯è¿™äº›æ ·æœ¬çš„å¹³å‡å€¼ã€‚è€ŒSSRæ˜¯æ¨¡å‹ä¸è§‚æµ‹æ•°æ®å·®çš„å¹³æ–¹æ±‚å’Œï¼Œ
å°±æ˜¯æ¨¡å‹æ²¡æœ‰è§£é‡Šçš„éƒ¨åˆ†ï¼Œæ‰€ä»¥ï¼ˆSST-SSRï¼‰/SSTå°±æ˜¯æ¨¡å‹è§£é‡Šäº†çš„æ¯”ä¾‹ï¼Œè¶Šæ¥è¿‘1è¶Šå¥½ã€‚

å¥½çš„æœ€åæˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹æˆ‘ä»¬è¦å…³æ³¨çš„residualsï¼Œä¹Ÿå°±æ˜¯æ¨¡å‹çš„æ®‹å·®å°±æ˜¯ $y_i-\hat{y_i}$ ï¼Œ
æˆ‘ä»¬æŠŠå®ƒplotå‡ºæ¥ï¼š
'''

# %%
plt.scatter(X, res.resid, label='data')  # res.residæ˜¯æ¨¡å‹çš„æ®‹å·®
plt.axhline(y=0, color='red', label='zero line')  # y=0çš„è¾…åŠ©çº¿
plt.legend()  # ç”»label
plt.show()
plt.hist(res.resid, edgecolor='black')  # ç›´æ–¹å›¾ï¼Œ edgecoloræ˜¯æŸ±å­çš„è¾¹ç•Œé¢œè‰²
plt.show() 
# %% [markdown]

'''
æˆ‘ä»¬åˆ†åˆ«ç”»å‡ºäº†æ®‹å·®çš„æ•£ç‚¹å›¾å’Œæ®‹å·®çš„ç›´æ–¹å›¾

é¦–å…ˆï¼Œæˆ‘ä»¬è¯´ä¸€ä¸‹ï¼Œ **ä¸€ä¸ªå›å½’æ¨¡å‹æ˜¯ä¸€ä¸ªå¥½çš„æ¨¡å‹çš„è¯ï¼Œä»–çš„æ®‹å·®åº”è¯¥æ˜¯å¹³å‡å€¼ä¸º0çš„ä¸€ä¸ªæ­£æ€åˆ†å¸ƒï¼ŒåŒæ—¶æ®‹å·®çš„åˆ†å¸ƒä¸åº”è¯¥éšç€xçš„å˜åŒ–è€Œå˜åŒ–** ã€‚

æˆ‘ä»¬å†çœ‹çœ‹æˆ‘ä»¬çš„æ®‹å·®ï¼Œå…¶ä¸­æœ‰ä¸€æ¡çº¢çº¿zero lineï¼Œå¯ä»¥çœ‹åˆ°æ®‹å·®åœ¨ä¸¤è¾¹åˆ†å¸ƒçš„è¿˜æ¯”è¾ƒå‡åŒ€ï¼Œå¹³å‡å€¼åº”è¯¥æ˜¯0é™„è¿‘ï¼Œè€Œä¸”å…¶åˆ†å¸ƒä¹Ÿæ²¡æœ‰éšxå˜åŒ–è€Œå˜åŒ–ã€‚  
å†çœ‹çœ‹åé¢çš„ç›´æ–¹å›¾ï¼Œæ®‹å·®ç¡®å®ä¹Ÿå¥½è±¡æ˜¯å¹³å‡å€¼ä¸º0çš„ä¸€ä¸ªæ­£æ€åˆ†å¸ƒï¼Œè¯´æ˜æˆ‘ä»¬çš„æ¨¡å‹è¿˜æŒºå¥½ã€‚

ä¸‹å›¾è¿™å‡ ä¸ªæ®‹å·®å›¾å°±ä¸æ˜¯ç‰¹åˆ«åˆé€‚ï¼š

![](2020-02-12-10-15-11.png)

æˆ‘ä»¬å†çœ‹ä¸€ä¸ªä¾‹å­
>exp2 ä¸‹é¢æ˜¯ä¸€ä¸ªæ°”æ¸©å’Œç”µè´¹å•çš„è¡¨æ ¼ï¼ˆä¸å®Œæ•´ï¼Œå®Œæ•´çš„å‚è€ƒé™„ä»¶ï¼‰ï¼Œè¯·æ ¹æ®æ°”æ¸©é¢„æµ‹ç”µè´¹ã€‚  

|    Temperature X    |    Energy Expense Y    |
|---------------------|------------------------|
|    46               |    $236                |
|    52               |    $304                |
|    55               |    $164                |
|    46               |    $214                |
|    47               |    $210                |
|    50               |    $508                |
|    36               |    $295                |

å¾ˆç®€å•å¯¹ä¸å¯¹ï¼Œæˆ‘ä»¬å¯¼å…¥æ•°æ®ï¼Œç„¶åä½ ä»¬çŸ¥é“ä»£ç æ€ä¹ˆå†™å¯¹å§ï¼š
'''
# %%
df_2 = pd.read_excel('exp2.xlsx')
plt.scatter(df_2.iloc[:, 0], df_2.iloc[:, 1])
# %%
from sklearn.preprocessing import PolynomialFeatures

# ä¹‹æ‰€ä»¥è¦reshapeæ˜¯å› ä¸ºå–å‡º1ä¸ªç‰¹å¾åçš„shapeæ˜¯ä¸€ç»´çš„ï¼Œåé¢çš„fit..ç­‰éƒ½è¦äºŒç»´çš„æ•°ç»„
# å¦‚æœæœ‰å¤šä¸ªindependent variableå–å‡ºæ¥ä¹‹åå°±ä¸éœ€è¦reshapeäº†ï¼Œå½“ç„¶yè¿˜æ˜¯è¦çš„
X = df_2.iloc[:, 0].values.reshape(-1, 1)
y = df_2.iloc[:, 1].values.reshape(-1, 1)

poly_reg = PolynomialFeatures(degree=4)  # degreeæ˜¯å¤šé¡¹å¼é˜¶æ•°
poly_X = poly_reg.fit_transform(X)  # å…ˆfit_transform()ä¸€ä¸‹å¾—åˆ°æ”¾åˆ°æ¨¡å‹é‡Œçš„X

poly_X_int = sm.add_constant(poly_X)  # åŠ æˆªè·
poly_model = sm.OLS(y, poly_X_int)  # å› ä¸ºXä»¥åŠå˜æˆé«˜æ¬¡å¤šé¡¹å¼äº†ï¼Œè¿˜æ˜¯ç”¨çº¿æ€§æ¨¡å‹æ‹Ÿåˆ
poly_res = poly_model.fit()

# ç”»æ‹Ÿåˆå›¾
plt.scatter(X, y, label='data')
poly_plot_X = np.linspace(X.min(), X.max(), 20).reshape(-1, 1)
poly_plot_X_int = sm.add_constant(poly_plot_X)
plt.plot(poly_plot_X, poly_res.predict(poly_reg.fit_transform(poly_plot_X)), color='red', label='fit curve')
plt.legend()

# adj_rsquared
poly_res.rsquared_adj
# %%
